#!/bin/bash

# ğŸŒ± LMS ë°ì´í„°ë² ì´ìŠ¤ ì‹œë“œ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ (ìˆ˜ì • ë²„ì „)
# 
# ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì´ˆê¸°í™”í•˜ê³  ì‹œë“œ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

set -e  # ì˜¤ë¥˜ ë°œìƒ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨

echo "ğŸŒ± LMS ë°ì´í„°ë² ì´ìŠ¤ ì‹œë“œ ì‹¤í–‰"
echo "================================="
echo ""

# í˜„ì¬ ìœ„ì¹˜ í™•ì¸
if [[ ! -f "packages/database/package.json" ]]; then
    echo "âŒ í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì—ì„œ ì‹¤í–‰í•´ì£¼ì„¸ìš”."
    exit 1
fi

echo "ğŸ“ í˜„ì¬ ìœ„ì¹˜: $(pwd)"
echo ""

# 1ë‹¨ê³„: CUID2 í…ŒìŠ¤íŠ¸
echo "ğŸ”§ 1ë‹¨ê³„: CUID2 ìƒì„± í…ŒìŠ¤íŠ¸"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [[ -f "./scripts/test-cuid2.sh" ]]; then
    ./scripts/test-cuid2.sh
else
    echo "âš ï¸ CUID2 í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ê±´ë„ˆëœë‹ˆë‹¤."
fi

echo ""

# 2ë‹¨ê³„: ê³µí†µ íŒ¨í‚¤ì§€ ë¹Œë“œ
echo "ğŸ“¦ 2ë‹¨ê³„: ê³µí†µ íŒ¨í‚¤ì§€ ë¹Œë“œ"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
cd packages/common
echo "ğŸ“¦ common íŒ¨í‚¤ì§€ ë¹Œë“œ ì¤‘..."
pnpm build
cd ../..

echo "âœ… ê³µí†µ íŒ¨í‚¤ì§€ ë¹Œë“œ ì™„ë£Œ"
echo ""

# 3ë‹¨ê³„: ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
echo "ğŸ—„ï¸ 3ë‹¨ê³„: ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
cd packages/database

echo "ğŸ”„ Prisma í´ë¼ì´ì–¸íŠ¸ ì¬ìƒì„± ì¤‘..."
npx prisma generate

echo "ğŸ—‘ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì¤‘..."
npx prisma db push --force-reset

echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ"
echo ""

# 4ë‹¨ê³„: ì‹œë“œ ë°ì´í„° ìƒì„±
echo "ğŸŒ± 4ë‹¨ê³„: ì‹œë“œ ë°ì´í„° ìƒì„±"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š ì‹œë“œ ë°ì´í„° ì‚½ì… ì¤‘..."

# tsxê°€ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
if ! command -v tsx &> /dev/null; then
    echo "ğŸ“¦ tsx ì„¤ì¹˜ ì¤‘..."
    pnpm install tsx --save-dev
fi

# ì‹œë“œ ì‹¤í–‰
pnpm seed:dev

cd ../..

echo ""
echo "ğŸ‰ ì‹œë“œ ì‘ì—… ì™„ë£Œ!"
echo ""
echo "ğŸ“Œ ë‹¤ìŒ ë‹¨ê³„:"
echo "  1. API ì„œë²„ ì‹œì‘: cd apps/api && pnpm start:dev"
echo "  2. ì¸ì¦ ì„œë²„ ì‹œì‘: cd apps/auth && pnpm start:dev"  
echo "  3. ì›¹ í´ë¼ì´ì–¸íŠ¸ ì‹œì‘: cd apps/web && pnpm dev"
echo ""
echo "âœ¨ í…ŒìŠ¤íŠ¸ ê³„ì •:"
echo "  ğŸ“§ ê°•ì‚¬: instructor1@example.com"
echo "  ğŸ“§ í•™ìƒ: student1@example.com"
echo "  ğŸ“§ ê´€ë¦¬ì: admin@example.com"
echo "  ğŸ”‘ ë¹„ë°€ë²ˆí˜¸: password123"
echo ""
